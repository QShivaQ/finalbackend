// =============================================================================
// CLEAN E-COMMERCE PRISMA SCHEMA
// =============================================================================
// This schema is designed for a modern apparel e-commerce platform
// No Payload CMS bloat - just clean, essential models
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// AUTHENTICATION & USERS
// =============================================================================

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String // Hashed
  name      String?
  role      UserRole @default(CUSTOMER)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  sessions  Session[]
  addresses Address[]
  orders    Order[]
  reviews   Review[]
  cart      Cart?

  @@index([email])
  @@map("users")
}

enum UserRole {
  CUSTOMER
  ADMIN
}

model Session {
  id        String   @id @default(uuid())
  userId    Int      @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("sessions")
}

model Address {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  company   String?
  address1  String
  address2  String?
  city      String
  province  String?
  country   String
  zip       String
  phone     String?
  isDefault Boolean  @default(false) @map("is_default")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user           User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  ordersShipping Order[] @relation("ShippingAddress")
  ordersBilling  Order[] @relation("BillingAddress")

  @@index([userId])
  @@map("addresses")
}

// =============================================================================
// MEDIA / IMAGES
// =============================================================================

model Media {
  id           Int      @id @default(autoincrement())
  url          String
  thumbnailUrl String?  @map("thumbnail_url")
  alt          String   @default("")
  filename     String?
  mimeType     String?  @map("mime_type")
  filesize     Int?
  width        Int?
  height       Int?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  productImages         ProductImage[]
  variantImages         VariantImage[]
  productMetaImages     Product[]       @relation("ProductMetaImage")
  categoryImages        Category[]
  collectionImages      Collection[]
  variantOptionSwatches VariantOption[] @relation("VariantOptionSwatch")

  @@map("media")
}

// =============================================================================
// CATEGORIES & COLLECTIONS
// =============================================================================

model Category {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  imageId     Int?     @map("image_id")
  parentId    String?  @map("parent_id")
  sortOrder   Int      @default(0) @map("sort_order")
  isVisible   Boolean  @default(true) @map("is_visible")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  image    Media?            @relation(fields: [imageId], references: [id], onDelete: SetNull)
  parent   Category?         @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Category[]        @relation("CategoryHierarchy")
  products ProductCategory[]

  @@index([slug])
  @@index([parentId])
  @@index([sortOrder])
  @@map("categories")
}

model Collection {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  imageId     Int?     @map("image_id")
  isVisible   Boolean  @default(true) @map("is_visible")
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  image    Media?              @relation(fields: [imageId], references: [id], onDelete: SetNull)
  products ProductCollection[]

  @@index([slug])
  @@index([sortOrder])
  @@map("collections")
}

// =============================================================================
// VARIANT TYPES & OPTIONS (e.g., Size: S/M/L, Color: Red/Blue)
// =============================================================================

model VariantType {
  id        Int      @id @default(autoincrement())
  name      String   @unique // e.g., "size", "color"
  label     String // e.g., "Size", "Color"
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  options VariantOption[]

  @@index([sortOrder])
  @@map("variant_types")
}

model VariantOption {
  id            Int      @id @default(autoincrement())
  variantTypeId Int      @map("variant_type_id")
  value         String // e.g., "small", "red"
  label         String // e.g., "Small", "Red"
  swatchImageId Int?     @map("swatch_image_id") // For color swatches
  sortOrder     Int      @default(0) @map("sort_order")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  variantType       VariantType              @relation(fields: [variantTypeId], references: [id], onDelete: Cascade)
  swatchImage       Media?                   @relation("VariantOptionSwatch", fields: [swatchImageId], references: [id], onDelete: SetNull)
  variantSelections VariantOptionSelection[]

  @@unique([variantTypeId, value])
  @@index([variantTypeId])
  @@index([sortOrder])
  @@map("variant_options")
}

// =============================================================================
// PRODUCTS
// =============================================================================

model Product {
  id          Int           @id @default(autoincrement())
  slug        String        @unique
  title       String
  description String?       @db.Text
  status      ProductStatus @default(DRAFT)
  isFeatured  Boolean       @default(false) @map("is_featured")

  // Pricing
  basePrice      Decimal  @default(0) @map("base_price") @db.Decimal(10, 2)
  compareAtPrice Decimal? @map("compare_at_price") @db.Decimal(10, 2)
  priceEnabled   Boolean  @default(true) @map("price_enabled")

  // Inventory
  trackInventory    Boolean @default(false) @map("track_inventory")
  inventoryQty      Int     @default(0) @map("inventory_qty")
  lowStockThreshold Int     @default(10) @map("low_stock_threshold")

  // Product Details
  brand            String?
  vendor           String?
  productType      String? @map("product_type")
  material         String?
  careInstructions String? @map("care_instructions") @db.Text
  madeIn           String? @map("made_in")

  // Variants
  hasVariants Boolean @default(false) @map("has_variants")

  // SEO
  metaTitle       String? @map("meta_title")
  metaDescription String? @map("meta_description")
  metaImageId     Int?    @map("meta_image_id")

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  publishedAt DateTime? @map("published_at")

  // Relations
  metaImage   Media?              @relation("ProductMetaImage", fields: [metaImageId], references: [id], onDelete: SetNull)
  images      ProductImage[]
  variants    ProductVariant[]
  categories  ProductCategory[]
  collections ProductCollection[]
  reviews     Review[]
  cartItems   CartItem[]
  orderItems  OrderItem[]

  @@index([slug])
  @@index([status])
  @@index([isFeatured])
  @@index([publishedAt])
  @@map("products")
}

enum ProductStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model ProductImage {
  id        Int      @id @default(autoincrement())
  productId Int      @map("product_id")
  imageId   Int      @map("image_id")
  sortOrder Int      @default(0) @map("sort_order")
  isPrimary Boolean  @default(false) @map("is_primary")
  createdAt DateTime @default(now()) @map("created_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  image   Media   @relation(fields: [imageId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([sortOrder])
  @@map("product_images")
}

// =============================================================================
// PRODUCT VARIANTS (e.g., "Red T-Shirt - Size M")
// =============================================================================

model ProductVariant {
  id        Int     @id @default(autoincrement())
  productId Int     @map("product_id")
  sku       String? @unique
  title     String? // e.g., "Red - Medium"

  // Pricing (overrides product base price if set)
  price          Decimal? @db.Decimal(10, 2)
  compareAtPrice Decimal? @map("compare_at_price") @db.Decimal(10, 2)

  // Inventory
  inventoryQty Int @default(0) @map("inventory_qty")

  // Physical attributes
  weight Decimal? @db.Decimal(10, 2) // in kg

  // Status
  status    ProductStatus @default(DRAFT)
  sortOrder Int           @default(0) @map("sort_order")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  product    Product                  @relation(fields: [productId], references: [id], onDelete: Cascade)
  images     VariantImage[]
  options    VariantOptionSelection[]
  cartItems  CartItem[]
  orderItems OrderItem[]

  @@index([productId])
  @@index([sku])
  @@index([status])
  @@index([sortOrder])
  @@map("product_variants")
}

model VariantImage {
  id        Int      @id @default(autoincrement())
  variantId Int      @map("variant_id")
  imageId   Int      @map("image_id")
  sortOrder Int      @default(0) @map("sort_order")
  isPrimary Boolean  @default(false) @map("is_primary")
  createdAt DateTime @default(now()) @map("created_at")

  variant ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  image   Media          @relation(fields: [imageId], references: [id], onDelete: Cascade)

  @@index([variantId])
  @@index([sortOrder])
  @@map("variant_images")
}

// Links variant to its specific options (e.g., variant "Red T-Shirt M" has options: color=red, size=m)
model VariantOptionSelection {
  id        Int      @id @default(autoincrement())
  variantId Int      @map("variant_id")
  optionId  Int      @map("option_id")
  createdAt DateTime @default(now()) @map("created_at")

  variant ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  option  VariantOption  @relation(fields: [optionId], references: [id], onDelete: Cascade)

  @@unique([variantId, optionId])
  @@index([variantId])
  @@index([optionId])
  @@map("variant_option_selections")
}

// =============================================================================
// PRODUCT RELATIONS (Many-to-Many)
// =============================================================================

model ProductCategory {
  productId  Int      @map("product_id")
  categoryId String   @map("category_id")
  createdAt  DateTime @default(now()) @map("created_at")

  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([productId, categoryId])
  @@index([productId])
  @@index([categoryId])
  @@map("product_categories")
}

model ProductCollection {
  productId    Int      @map("product_id")
  collectionId String   @map("collection_id")
  sortOrder    Int      @default(0) @map("sort_order")
  createdAt    DateTime @default(now()) @map("created_at")

  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@id([productId, collectionId])
  @@index([productId])
  @@index([collectionId])
  @@index([sortOrder])
  @@map("product_collections")
}

// =============================================================================
// SHOPPING CART
// =============================================================================

model Cart {
  id        String    @id @default(uuid())
  userId    Int?      @unique @map("user_id") // null for guest carts
  sessionId String?   @map("session_id") // For guest carts
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  expiresAt DateTime? @map("expires_at")

  user  User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]

  @@index([userId])
  @@index([sessionId])
  @@map("carts")
}

model CartItem {
  id        Int      @id @default(autoincrement())
  cartId    String   @map("cart_id")
  productId Int      @map("product_id")
  variantId Int?     @map("variant_id")
  quantity  Int      @default(1)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  cart    Cart            @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId, variantId])
  @@index([cartId])
  @@index([productId])
  @@map("cart_items")
}

// =============================================================================
// ORDERS
// =============================================================================

model Order {
  id          Int    @id @default(autoincrement())
  orderNumber String @unique @map("order_number")
  userId      Int    @map("user_id")

  // Addresses
  shippingAddressId Int @map("shipping_address_id")
  billingAddressId  Int @map("billing_address_id")

  // Pricing
  subtotal       Decimal @db.Decimal(10, 2)
  shippingCost   Decimal @default(0) @map("shipping_cost") @db.Decimal(10, 2)
  taxAmount      Decimal @default(0) @map("tax_amount") @db.Decimal(10, 2)
  discountAmount Decimal @default(0) @map("discount_amount") @db.Decimal(10, 2)
  total          Decimal @db.Decimal(10, 2)

  // Status
  orderStatus       OrderStatus       @default(PENDING) @map("order_status")
  paymentStatus     PaymentStatus     @default(PENDING) @map("payment_status")
  fulfillmentStatus FulfillmentStatus @default(UNFULFILLED) @map("fulfillment_status")

  // Payment
  paymentMethod String? @map("payment_method")
  transactionId String? @map("transaction_id")

  // Shipping
  shippingMethod  String? @map("shipping_method")
  trackingNumber  String? @map("tracking_number")
  shippingCarrier String? @map("shipping_carrier")

  // Notes
  customerNote String? @map("customer_note") @db.Text
  internalNote String? @map("internal_note") @db.Text

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  paidAt      DateTime? @map("paid_at")
  shippedAt   DateTime? @map("shipped_at")
  deliveredAt DateTime? @map("delivered_at")
  cancelledAt DateTime? @map("cancelled_at")

  // Relations
  user            User        @relation(fields: [userId], references: [id])
  shippingAddress Address     @relation("ShippingAddress", fields: [shippingAddressId], references: [id])
  billingAddress  Address     @relation("BillingAddress", fields: [billingAddressId], references: [id])
  items           OrderItem[]

  @@index([userId])
  @@index([orderNumber])
  @@index([orderStatus])
  @@index([paymentStatus])
  @@index([createdAt])
  @@map("orders")
}

enum OrderStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum FulfillmentStatus {
  UNFULFILLED
  PARTIALLY_FULFILLED
  FULFILLED
  SHIPPED
  DELIVERED
  CANCELLED
}

model OrderItem {
  id        Int  @id @default(autoincrement())
  orderId   Int  @map("order_id")
  productId Int  @map("product_id")
  variantId Int? @map("variant_id")

  // Snapshot of product data at time of order
  productTitle String  @map("product_title")
  variantTitle String? @map("variant_title")
  sku          String?

  // Pricing
  price    Decimal @db.Decimal(10, 2)
  quantity Int
  subtotal Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now()) @map("created_at")

  order   Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

// =============================================================================
// REVIEWS
// =============================================================================

model Review {
  id          Int      @id @default(autoincrement())
  productId   Int      @map("product_id")
  userId      Int      @map("user_id")
  rating      Int // 1-5
  title       String?
  content     String?  @db.Text
  isVerified  Boolean  @default(false) @map("is_verified") // Purchased product
  isPublished Boolean  @default(true) @map("is_published")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([userId])
  @@index([rating])
  @@map("reviews")
}

// =============================================================================
// THEME SYSTEM (CMS-ready)
// =============================================================================

model Theme {
  id        Int      @id @default(autoincrement())
  name      String   @unique // e.g., "Default", "Dark Mode", "Glassmorphism"
  isActive  Boolean  @default(false) @map("is_active") // Only one active theme at a time
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Color Palette
  colorPrimary       String @default("#3B82F6") @map("color_primary") // Blue-600
  colorSecondary     String @default("#8B5CF6") @map("color_secondary") // Violet-600
  colorAccent        String @default("#EC4899") @map("color_accent") // Pink-600
  colorSuccess       String @default("#10B981") @map("color_success") // Green-600
  colorWarning       String @default("#F59E0B") @map("color_warning") // Amber-600
  colorError         String @default("#EF4444") @map("color_error") // Red-600
  colorInfo          String @default("#06B6D4") @map("color_info") // Cyan-600
  colorBackground    String @default("#FFFFFF") @map("color_background") // White
  colorSurface       String @default("#F9FAFB") @map("color_surface") // Gray-50
  colorTextPrimary   String @default("#111827") @map("color_text_primary") // Gray-900
  colorTextSecondary String @default("#6B7280") @map("color_text_secondary") // Gray-500
  colorBorder        String @default("#E5E7EB") @map("color_border") // Gray-200

  // Glassmorphism Effects
  glassOpacity      Float @default(0.7) @map("glass_opacity") // 0.0 - 1.0
  glassBlur         Int   @default(12) @map("glass_blur") // px
  glassBorder       Float @default(1) @map("glass_border") // px
  glassBorderOpacity Float @default(0.2) @map("glass_border_opacity") // 0.0 - 1.0
  glassShadow       String @default("0 8px 32px rgba(0, 0, 0, 0.1)") @map("glass_shadow")

  // Typography
  fontHeading   String @default("Inter, system-ui, sans-serif") @map("font_heading")
  fontBody      String @default("Inter, system-ui, sans-serif") @map("font_body")
  fontMono      String @default("JetBrains Mono, monospace") @map("font_mono")
  fontSize      String @default("16px") @map("font_size") // Base font size
  fontWeightNormal Int @default(400) @map("font_weight_normal")
  fontWeightMedium Int @default(500) @map("font_weight_medium")
  fontWeightBold   Int @default(700) @map("font_weight_bold")
  lineHeight    Float @default(1.5) @map("line_height")
  letterSpacing Float @default(0) @map("letter_spacing") // em

  // Spacing Scale (in px or rem)
  spacingXs     String @default("0.25rem") @map("spacing_xs") // 4px
  spacingSm     String @default("0.5rem") @map("spacing_sm") // 8px
  spacingMd     String @default("1rem") @map("spacing_md") // 16px
  spacingLg     String @default("1.5rem") @map("spacing_lg") // 24px
  spacingXl     String @default("2rem") @map("spacing_xl") // 32px
  spacing2xl    String @default("3rem") @map("spacing_2xl") // 48px
  spacing3xl    String @default("4rem") @map("spacing_3xl") // 64px

  // Border Radius
  borderRadiusSm String @default("0.25rem") @map("border_radius_sm") // 4px
  borderRadiusMd String @default("0.5rem") @map("border_radius_md") // 8px
  borderRadiusLg String @default("0.75rem") @map("border_radius_lg") // 12px
  borderRadiusXl String @default("1rem") @map("border_radius_xl") // 16px
  borderRadiusFull String @default("9999px") @map("border_radius_full")

  // Animations
  transitionSpeed String @default("200ms") @map("transition_speed") // Default animation speed
  transitionEasing String @default("cubic-bezier(0.4, 0, 0.2, 1)") @map("transition_easing") // Ease in-out

  // Layout
  maxWidthContainer String @default("1280px") @map("max_width_container")
  maxWidthContent   String @default("65ch") @map("max_width_content")
  headerHeight      String @default("4rem") @map("header_height")
  footerHeight      String @default("auto") @map("footer_height")

  // Custom CSS (for advanced customization)
  customCss String? @map("custom_css") @db.Text

  @@map("themes")
}
